<!DOCTYPE html>
<html lang="en">
<head>
    <head th:replace="head"></head>
    <title>商品修改</title>
    <link href="https://admin.offway.cn/assets/js/select2/select2.css" rel="stylesheet"/>
    <link href="https://admin.offway.cn/assets/js/select2/select2-bootstrap.css" rel="stylesheet"/>
    <link href="https://admin.offway.cn/assets/css/jquery-editable-select.min.css" rel="stylesheet"/>
    <link href="https://admin.offway.cn/assets/css/jquery-ui.min.css" rel="stylesheet"/>
    <link href="https://admin.offway.cn/assets/css/jquery-ui.structure.min.css" rel="stylesheet"/>
    <link href="https://admin.offway.cn/assets/css/jquery-ui.theme.min.css" rel="stylesheet"/>
    <script src="https://unpkg.com/qiniu-js@2.5.3/dist/qiniu.min.js"></script>
    <style type="text/css">
        .form-group img {
            max-width: 400px;
            max-height: 300px;
        }
    </style>
</head>

<body class="hold-transition skin-black light-sidebar sidebar-mini">
<div class="wrapper">
    <header th:replace="navbar"></header>
    <aside th:replace="sidebar-menu"></aside>
    <div class="content-wrapper">
        <div class="content-header d-none d-md-block">
            <div class="d-flex align-items-center">
                <div class="mr-auto">
                    <h1 class="title">商品修改</h1>
                </div>
                <div class="right-title">
                </div>
            </div>
        </div>
        <section class="content">
            <div class="row">
                <div class="col-12">
                    <div class="box">
                        <div class="box-header with-border">
                            <form class="form-horizontal" id="saveForm" role="form">
                                <input name="id" type="hidden"/>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label class="control-label"><font color="red">*</font>商品类别</label>
                                            <select class="form-control" id="type" name="type" onchange="renderCategory(this)"
                                                    placeholder="商品类别">
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label class="control-label"><font color="red">*</font>商品子类别</label>
                                            <select class="form-control" id="category" name="category"
                                                    onchange="renderKind(this)" placeholder="商品子类别">
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label class="control-label"><font color="red">*</font>商品三级类别</label>
                                            <select class="form-control" id="kind" name="kind" placeholder="商品三级类别">
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <label class="control-label" for="field-3">*名称</label>
                                            <input class="form-control" id="field-3" name="name" placeholder="名称"
                                                   type="text"/>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label class="control-label" for="field-3"><font
                                                    color="red">*</font>是否限定</label>
                                            <label><input checked="checked" class="" name="isOffway" type="radio"
                                                          value="0"/>限定</label>
                                            <label><input class="" name="isOffway" type="radio" value="1"/>非限定</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <label class="control-label" for="field-4">*封面图片</label>
                                            <input class="form-control" id="field-4" name="imageFile" placeholder="封面图片"
                                                   type="file"/>
                                            <input class="form-control" name="image" type="hidden"/>
                                            <img alt="" name="imageImg" src="" style="display:none;"/>
                                        </div>
                                    </div>
                                </div>
                                <div class="row" id="bannerDIV">
                                    <div class="col-md-2">
                                        <div class="form-group">
                                            <label class="control-label">banner 轮播图</label>
                                            <input class="form-control" name="bannerFile" onchange="uploadFile(this)"
                                                   placeholder="banner 轮播图" type="file"/>
                                            <input class="form-control notMe btn btn-danger" name="bannerReset" onclick="resetImg(this)"
                                                   style="display:none;" type="button" value="清空图片"/>
                                            <input class="form-control" name="banner" type="hidden"/>
                                            <img alt="" name="bannerImg" src="" style="display:none;"/>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="form-group">
                                            <label class="control-label">banner 轮播图</label>
                                            <input class="form-control" name="bannerFile" onchange="uploadFile(this)"
                                                   placeholder="banner 轮播图" type="file"/>
                                            <input class="form-control notMe btn btn-danger" name="bannerReset" onclick="resetImg(this)"
                                                   style="display:none;" type="button" value="清空图片"/>
                                            <input class="form-control" name="banner" type="hidden"/>
                                            <img alt="" name="bannerImg" src="" style="display:none;"/>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="form-group">
                                            <label class="control-label">banner 轮播图</label>
                                            <input class="form-control" name="bannerFile" onchange="uploadFile(this)"
                                                   placeholder="banner 轮播图" type="file"/>
                                            <input class="form-control notMe btn btn-danger" name="bannerReset" onclick="resetImg(this)"
                                                   style="display:none;" type="button" value="清空图片"/>
                                            <input class="form-control" name="banner" type="hidden"/>
                                            <img alt="" name="bannerImg" src="" style="display:none;"/>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="form-group">
                                            <label class="control-label">banner 轮播图</label>
                                            <input class="form-control" name="bannerFile" onchange="uploadFile(this)"
                                                   placeholder="banner 轮播图" type="file"/>
                                            <input class="form-control notMe btn btn-danger" name="bannerReset" onclick="resetImg(this)"
                                                   style="display:none;" type="button" value="清空图片"/>
                                            <input class="form-control" name="banner" type="hidden"/>
                                            <img alt="" name="bannerImg" src="" style="display:none;"/>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="form-group">
                                            <label class="control-label">banner 轮播图</label>
                                            <input class="form-control" name="bannerFile" onchange="uploadFile(this)"
                                                   placeholder="banner 轮播图" type="file"/>
                                            <input class="form-control notMe btn btn-danger" name="bannerReset" onclick="resetImg(this)"
                                                   style="display:none;" type="button" value="清空图片"/>
                                            <input class="form-control" name="banner" type="hidden"/>
                                            <img alt="" name="bannerImg" src="" style="display:none;"/>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="form-group">
                                            <label class="control-label">banner 轮播图</label>
                                            <input class="form-control" name="bannerFile" onchange="uploadFile(this)"
                                                   placeholder="banner 轮播图" type="file"/>
                                            <input class="form-control notMe btn btn-danger" name="bannerReset" onclick="resetImg(this)"
                                                   style="display:none;" type="button" value="清空图片"/>
                                            <input class="form-control" name="banner" type="hidden"/>
                                            <img alt="" name="bannerImg" src="" style="display:none;"/>
                                        </div>
                                    </div>
                                </div>
                                <div class="row" id="introDIV">
                                    <div class="col-md-2">
                                        <div class="form-group">
                                            <input class="form-control" id="addIntroFileBtn" onclick="addIntroFile(this)" type="button"
                                                   value="添加"/>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <label class="control-label" for="field-5">*品牌</label>
                                            <select class="form-control" id="field-5" name="brand_id" placeholder="品牌">
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <label class="control-label" for="field-8">备注</label>
                                            <input class="form-control" id="field-8" name="remark" placeholder="备注"
                                                   type="text"/>
                                        </div>
                                    </div>
                                </div>
                                <div id="skuProperty">
                                    <input id="addMoreAttrButton" onclick="addMoreAttr(this,false)" style="display: none"
                                           type="button" value="添加商品属性(如颜色、尺码等)"/>
                                </div>
                                <div id="skuContainer">
                                </div>
                                <div class="modal-footer">
                                    <button class="btn btn-success save" type="button">保存</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
		</section>
            <footer th:replace="footer"></footer>
    </div>
</div>

<div th:replace="body-under"></div>

<div aria-hidden="false" class="modal fade in" id="modal-7" style="display: none;z-index: 2000">
</div>
<input id="stockHolder" type="hidden" value=""/>
<input id="type_and_category_list" type="hidden"/>
<script src="https://admin.offway.cn/js/common1.js"></script>
<script src="https://admin.offway.cn/assets/js/moment.min.js"></script>
<script src="https://admin.offway.cn/assets/js/select2/select2.min.js"></script>
<script src="https://admin.offway.cn/assets/js/async.min.js"></script>
<script src="https://admin.offway.cn/assets/js/jquery.base64.js"></script>
<script src="https://admin.offway.cn/assets/js/distpicker.js"></script>
<script src="https://admin.offway.cn/assets/js/jquery-editable-select.min.js"></script>
<script src="https://admin.offway.cn/assets/js/jquery-ui.min.js"></script>
<script th:inline="javascript">
    /*<![CDATA[*/

    function getQNToken(cb) {
        $.get("/qiniu/token", {}, function (token) {
            cb(token);
        });
    }

    function uploadFile(self) {
        var that = $(self);
        if (self.files.length > 0) {
            var file = self.files[0];
            getQNToken(function (token) {
                this.upload("", token, file, function () {
                    //
                }, function (err) {
                    console.log("error");
                    console.log(err);
                }, function (res) {
                    var url = qiniuUrl + "/" + res.key;
                    that.parent().find("[name=banner]").val(url);
                    that.parent().find("[name=bannerImg]").attr("src", url);
                    that.parent().find("[name=bannerImg]").attr("width", "100px");
                    that.parent().find("[name=bannerImg]").attr("height", "100px");
                    that.parent().find("[name=bannerImg]").show();
                    that.parent().find("[name=bannerReset]").show();
                });
            });
        } else {
            confirm("未选择任何文件!");
        }
    }

    function uploadSkuImg(self) {
        var that = $(self);
        if (self.files.length > 0) {
            var file = self.files[0];
            getQNToken(function (token) {
                this.upload("", token, file, function () {
                    //
                }, function (err) {
                    console.log("error");
                    console.log(err);
                }, function (res) {
                    var url = qiniuUrl + "/" + res.key;
                    that.parent().find("[name=skuImg]").val(url);
                    that.parent().find("img").attr("src", url);
                    that.parent().find("img").show();
                    // that.parent().find("[name=introImg]").attr("width", "100px");
                    // that.parent().find("[name=introImg]").attr("height", "100px");
                });
            });
        } else {
            confirm("未选择任何文件!");
        }
    }

    function resetImg(self) {
        var that = $(self);
        var div = that.parent();
        div.find("input[name='bannerFile']").val("");
        div.find("input[name='banner']").val("");
        div.find("img[name='bannerImg']").hide();
        div.find("img[name='bannerImg']").attr("src", "");
        that.hide();
    }

    function delIntroFile(self) {
        var that = $(self);
        that.parent().parent().remove();
    }

    function addIntroFile(self, url) {
        var that = $(self);
        if (url != null) {
            that.parent().parent().before("\t\t\t\t\t\t<div class=\"col-md-2\">\n" +
                "\t\t\t\t\t\t\t<div class=\"form-group\">\n" +
                "\t\t\t\t\t\t\t\t<label class=\"control-label\">商品长图</label>\n" +
                "\t\t\t\t\t\t\t\t<input type=\"file\" class=\"form-control\" name=\"introFile\" placeholder=\"商品长图\" onchange=\"uploadIntroFile(this)\"/>\n" +
                "\t\t\t\t\t\t\t\t<input type=\"button\" class=\"form-control notMe btn btn-danger\" value=\"删除\" onclick=\"delIntroFile(this)\"/>\n" +
                "\t\t\t\t\t\t\t\t<input type=\"hidden\" class=\"form-control\" name=\"intro\" value='SRC' />\n".replace("SRC", url) +
                "\t\t\t\t\t\t\t\t<img alt=\"\" src=\"SRC\" name=\"introImg\"/>\n".replace("SRC", url) +
                "\t\t\t\t\t\t\t</div>\n" +
                "\t\t\t\t\t\t</div>");
        } else {
            that.parent().parent().before("\t\t\t\t\t\t<div class=\"col-md-2\">\n" +
                "\t\t\t\t\t\t\t<div class=\"form-group\">\n" +
                "\t\t\t\t\t\t\t\t<label class=\"control-label\">商品长图</label>\n" +
                "\t\t\t\t\t\t\t\t<input type=\"file\" class=\"form-control\" name=\"introFile\" placeholder=\"商品长图\" onchange=\"uploadIntroFile(this)\"/>\n" +
                "\t\t\t\t\t\t\t\t<input type=\"button\" class=\"form-control notMe btn btn-danger\" value=\"删除\" onclick=\"delIntroFile(this)\"/>\n" +
                "\t\t\t\t\t\t\t\t<input type=\"hidden\" class=\"form-control\" name=\"intro\" />\n" +
                "\t\t\t\t\t\t\t\t<img alt=\"\" src=\"\" name=\"introImg\" style=\"display:none;\" />\n" +
                "\t\t\t\t\t\t\t</div>\n" +
                "\t\t\t\t\t\t</div>");
        }
    }

    function uploadIntroFile(self) {
        var that = $(self);
        if (self.files.length > 0) {
            var file = self.files[0];
            getQNToken(function (token) {
                this.upload("", token, file, function () {
                    //
                }, function (err) {
                    console.log("error");
                    console.log(err);
                }, function (res) {
                    var url = qiniuUrl + "/" + res.key;
                    that.parent().find("[name=intro]").val(url);
                    that.parent().find("[name=introImg]").attr("src", url);
                    that.parent().find("[name=introImg]").attr("width", "100px");
                    that.parent().find("[name=introImg]").attr("height", "100px");
                    that.parent().find("[name=introImg]").show();
                });
            });
        } else {
            confirm("未选择任何文件!");
        }
    }

    function initCommonSku(savedSku) {
        var commonSku = {
            "颜色": [
                // {"value": "赤", "remark": "", "sort": 1},
                // {"value": "橙", "remark": "", "sort": 2},
                // {"value": "黄", "remark": "", "sort": 3},
                // {"value": "绿", "remark": "", "sort": 4},
                // {"value": "青", "remark": "", "sort": 5},
                // {"value": "蓝", "remark": "", "sort": 6},
                // {"value": "紫", "remark": "", "sort": 7}
            ],
            "尺码": [
                // {"value": "大", "remark": "L", "sort": 1},
                // {"value": "小", "remark": "S", "sort": 2},
                // {"value": "中", "remark": "M", "sort": 3},
                // {"value": "特大", "remark": "XL", "sort": 4},
                // {"value": "特小", "remark": "XS", "sort": 5},
                // {"value": "特特大", "remark": "XXL", "sort": 6},
                // {"value": "特特小", "remark": "XXS", "sort": 7}
            ]
        };
        if (savedSku != null) {
            commonSku = savedSku;
        }
        // //添加颜色
        // addMoreAttr("#addMoreAttrButton", true);
        // //添加尺码
        // addMoreAttr("#addMoreAttrButton", true);
        for (var i in commonSku) {
            addMoreAttr("#addMoreAttrButton", true);
        }
        var attrNameList = $("#skuProperty").find("[name='attrName']");
        var attrValueList = $("#skuProperty").find("[name='attrValue']");
        var attrContainerList = $("#skuProperty").find("[name='attrContainer']");
        var i = 0;
        for (var name in commonSku) {
            $(attrNameList[i]).val(name);
            var vList = [];
            for (var value in commonSku[name]) {
                vList.push(commonSku[name][value]["value"]);
            }
            $(attrValueList[i]).val(vList.join(","));
            $(attrContainerList[i]).val(JSON.stringify(commonSku[name]));
            i++;
        }
    }

    function switchToCommon(savedSku) {
        initCommonSku(savedSku);
        $("#addMoreAttrButton").hide();
        // generateSKUList();
    }

    function switchToCustom() {
        $("#skuProperty").find(".row").remove();
        $("#addMoreAttrButton").show();
        generateSKUList();
    }

    function delNode(self, refresh) {
        var that = $(self);
        var name = that.attr("name");
        $(".NAME".replace("NAME", name)).remove();
        if (refresh) {
            generateSKUList();
        }
    }

    function addMoreAttr(self, readonly) {
        var uuid = UUID.randomUUID();
        var hasImg = $("#skuProperty .row").length < 1;
        var content = buildNewAttr(uuid, readonly, hasImg);
        var that = $(self);
        that.before(content);
    }

    function buildNewAttr(uuid, readonly, hasImg) {
        var contentStr = "\t\t\t\t\t<div class=\"row NAME\">\n".replace("NAME", uuid) +
            "\t\t\t\t\t\t<div class=\"col-md-5\">\n" +
            "\t\t\t\t\t\t\t<div class=\"form-group\">\n" +
            "\t\t\t\t\t\t\t\t<label class=\"control-label\">MAIN</label>\n".replace("MAIN", hasImg ? "主规格名称(如颜色、尺寸)" : "规格名称(如颜色、尺寸)");
        if (readonly) {
            contentStr += "\t\t\t\t\t\t\t\t<input type='text' readonly='readonly' class=\"form-control\" name=\"attrName\" placeholder=\"规格名称(如颜色、尺寸)\" />\n";
        } else {
            contentStr += "\t\t\t\t\t\t\t\t<input type='text' class=\"form-control\" name=\"attrName\" placeholder=\"规格名称(如颜色、尺寸)\" />\n";
        }
        if (hasImg) {
            contentStr += "\t\t\t\t\t\t\t</div>\n" +
                "\t\t\t\t\t\t</div>\n" +
                "\t\t\t\t\t\t<div class=\"col-md-5\">\n" +
                "\t\t\t\t\t\t\t<div class=\"form-group\">\n" +
                "\t\t\t\t\t\t\t\t<label class=\"control-label\">主规格详细规格(如红、黄、S、M、L)</label>\n" +
                "\t\t\t\t\t\t\t\t<input type='text' readonly='readonly' class=\"form-control\" name=\"attrValue\" placeholder=\"主规格详细规格(如红、黄、S、M、L),点击设置\" onclick=\"showAttrWindow('NAME',true)\" />\n".replace("NAME", uuid) +
                "\t\t\t\t\t\t\t\t<input type='hidden' class=\"form-control NAME\" name=\"attrContainer\" value=\"\" />\n".replace("NAME", uuid) +
                "\t\t\t\t\t\t\t</div>\n" +
                "\t\t\t\t\t\t</div>\n" +
                "\t\t\t\t\t\t<div class=\"col-md-2\">\n" +
                "\t\t\t\t\t\t\t<div class=\"form-group\">\n" +
                "\t\t\t\t\t\t\t\t<label class=\"control-label\">操作</label>\n";
        } else {
            contentStr += "\t\t\t\t\t\t\t</div>\n" +
                "\t\t\t\t\t\t</div>\n" +
                "\t\t\t\t\t\t<div class=\"col-md-5\">\n" +
                "\t\t\t\t\t\t\t<div class=\"form-group\">\n" +
                "\t\t\t\t\t\t\t\t<label class=\"control-label\">详细规格(如红、黄、S、M、L)</label>\n" +
                "\t\t\t\t\t\t\t\t<input type='text' readonly='readonly' class=\"form-control\" name=\"attrValue\" placeholder=\"详细规格(如红、黄、S、M、L),点击设置\" onclick=\"showAttrWindow('NAME',false)\" />\n".replace("NAME", uuid) +
                "\t\t\t\t\t\t\t\t<input type='hidden' class=\"form-control NAME\" name=\"attrContainer\" value=\"\" />\n".replace("NAME", uuid) +
                "\t\t\t\t\t\t\t</div>\n" +
                "\t\t\t\t\t\t</div>\n" +
                "\t\t\t\t\t\t<div class=\"col-md-2\">\n" +
                "\t\t\t\t\t\t\t<div class=\"form-group\">\n" +
                "\t\t\t\t\t\t\t\t<label class=\"control-label\">操作</label>\n";
        }
        if (readonly) {
            contentStr += "\t\t\t\t\t\t\t\t<input type='button' class=\"form-control NAME\" name=\"NAME\" value=\"删除\" disabled='disabled' onclick=\"delNode(this,true)\" />\n".replace(/NAME/g, uuid);
        } else {
            contentStr += "\t\t\t\t\t\t\t\t<input type='button' class=\"form-control NAME\" name=\"NAME\" value=\"删除\" onclick=\"delNode(this,true)\" />\n".replace(/NAME/g, uuid);
        }
        contentStr += "\t\t\t\t\t\t\t</div>\n" +
            "\t\t\t\t\t\t</div>\n" +
            "\t\t\t\t\t</div>";
        return contentStr;
    }

    function calcHighestSort() {
        var form = jQuery('#modal-7');
        var skuSortList = form.find("input[name=skuSort]");
        var highestSort = 0;
        for (var i in skuSortList) {
            if (isNaN(i)) {
                continue;
            }
            var nowSort = parseInt(skuSortList[i].value);
            highestSort = highestSort >= nowSort ? highestSort : nowSort;
        }
        return highestSort;
    }

    function addMoreAttrValue(self, hasImg) {
        var uuid = UUID.randomUUID();
        var newSort = calcHighestSort() + 1;
        var content = buildNewAttrValue(uuid, null, null, newSort, "", null, hasImg);
        var that = $(self);
        that.before(content);
    }

    function buildNewAttrValue(uuid, one, two, three, four, five, hasImg) {
        var context = hasImg ? ATTR_ELEMENT_BODY_IMG : ATTR_ELEMENT_BODY;
        context = context.replace(/UUID/g, uuid);
        if (one != undefined) {
            context = context.replace("ONE", one);
        } else {
            context = context.replace("ONE", "");
        }
        if (two != undefined) {
            context = context.replace("TWO", two);
        } else {
            context = context.replace("TWO", "");
        }
        if (three != undefined) {
            context = context.replace("THREE", three);
        } else {
            context = context.replace("THREE", "0");
        }
        if (four != undefined) {
            context = context.replace("FOUR", four);
        } else {
            context = context.replace("FOUR", "");
        }
        if (five != undefined) {
            context = context.replace("DELETE", "disabled='disabled'");
        } else {
            context = context.replace("DELETE", "");
        }
        return context;
    }

    var ATTR_ELEMENT_HEADER = "\t\t<div class=\"modal-dialog\">\n" +
        "\t\t\t<div class=\"modal-content\">\n" +
        "\t\t\t\t<div class=\"modal-header\">\n" +
        "\t\t\t\t\t<button type=\"button\" class=\"close\" data-dismiss=\"modal\" aria-hidden=\"true\">×</button>\n" +
        "\t\t\t\t\t<h4 class=\"modal-title\">添加商品详细属性列表</h4>\n" +
        "\t\t\t\t</div>\n" +
        "\t\t\t\t<div class=\"modal-body\">\n";

    var ATTR_ELEMENT_BODY = "\t\t\t\t\t<div class=\"row UUID\">\n" +
        "\t\t\t\t\t\t<div class=\"col-md-4\">\n" +
        "\t\t\t\t\t\t\t<div class=\"form-group\">\n" +
        "\t\t\t\t\t\t\t\t<label for=\"field-4\" class=\"control-label\">商品属性值</label>\n" +
        "\t\t\t\t\t\t\t\t<input type=\"text\" class=\"form-control\" name=\"skuValue\" value='ONE' placeholder=\"商品属性值\" />\n" +
        "\t\t\t\t\t\t\t</div>\n" +
        "\t\t\t\t\t\t</div>\n" +
        "\t\t\t\t\t\t<div class=\"col-md-4\">\n" +
        "\t\t\t\t\t\t\t<div class=\"form-group\">\n" +
        "\t\t\t\t\t\t\t\t<label for=\"field-5\" class=\"control-label\">备注</label>\n" +
        "\t\t\t\t\t\t\t\t<input type=\"text\" class=\"form-control\" name=\"skuRemark\" value='TWO' placeholder=\"备注\" />\n" +
        "\t\t\t\t\t\t\t</div>\n" +
        "\t\t\t\t\t\t</div>\n" +
        "\t\t\t\t\t\t<div class=\"col-md-2\">\n" +
        "\t\t\t\t\t\t\t<div class=\"form-group\">\n" +
        "\t\t\t\t\t\t\t\t<label for=\"field-6\" class=\"control-label\">排序</label>\n" +
        "\t\t\t\t\t\t\t\t<input type=\"number\" class=\"form-control\" name=\"skuSort\" readonly='readonly' value='THREE'  placeholder=\"排序\" />\n" +
        "\t\t\t\t\t\t\t</div>\n" +
        "\t\t\t\t\t\t</div>\n" +
        "\t\t\t\t\t\t<div class=\"col-md-2\">\n" +
        "\t\t\t\t\t\t\t<div class=\"form-group\">\n" +
        "\t\t\t\t\t\t\t\t<label for=\"field-6\" class=\"control-label\">操作</label>\n" +
        "\t\t\t\t\t\t\t\t<input type=\"button\" class=\"form-control UUID\" name=\"UUID\" value='删除' DELETE onclick=\"delNode(this,false)\" />\n" +
        "\t\t\t\t\t\t\t</div>\n" +
        "\t\t\t\t\t\t</div>\n" +
        "\t\t\t\t\t</div>\n";

    var ATTR_ELEMENT_BODY_IMG = "\t\t\t\t\t<div class=\"row UUID\">\n" +
        "\t\t\t\t\t\t<div class=\"col-md-4\">\n" +
        "\t\t\t\t\t\t\t<div class=\"form-group\">\n" +
        "\t\t\t\t\t\t\t\t<label for=\"field-4\" class=\"control-label\">商品属性值</label>\n" +
        "\t\t\t\t\t\t\t\t<input type=\"text\" class=\"form-control\" name=\"skuValue\" value='ONE' placeholder=\"商品属性值\" />\n" +
        "\t\t\t\t\t\t\t</div>\n" +
        "\t\t\t\t\t\t</div>\n" +
        "\t\t\t\t\t\t<div class=\"col-md-4\">\n" +
        "\t\t\t\t\t\t\t<div class=\"form-group\">\n" +
        "\t\t\t\t\t\t\t\t<label for=\"field-5\" class=\"control-label\">图片</label>\n" +
        "\t\t\t\t\t\t\t\t<input type=\"file\" class=\"form-control\" name=\"skuImgFile\" onchange='uploadSkuImg(this)' placeholder=\"图片\" />\n" +
        "\t\t\t\t\t\t\t\t<input type=\"hidden\" class=\"form-control\" name=\"skuImg\" value='FOUR' placeholder=\"图片\" />\n" +
        "\t\t\t\t\t\t\t\t<img src='FOUR' style='width: 100px;height: 100px;display: none' />\n" +
        "\t\t\t\t\t\t\t</div>\n" +
        "\t\t\t\t\t\t</div>\n" +
        "\t\t\t\t\t\t<div class=\"col-md-2\">\n" +
        "\t\t\t\t\t\t\t<div class=\"form-group\">\n" +
        "\t\t\t\t\t\t\t\t<label for=\"field-5\" class=\"control-label\">备注</label>\n" +
        "\t\t\t\t\t\t\t\t<input type=\"text\" class=\"form-control\" name=\"skuRemark\" value='TWO' placeholder=\"备注\" />\n" +
        "\t\t\t\t\t\t\t</div>\n" +
        "\t\t\t\t\t\t</div>\n" +
        "\t\t\t\t\t\t<div style='display: none'>\n" +
        "\t\t\t\t\t\t\t<div class=\"form-group\">\n" +
        "\t\t\t\t\t\t\t\t<label for=\"field-6\" class=\"control-label\">排序</label>\n" +
        "\t\t\t\t\t\t\t\t<input type=\"number\" class=\"form-control\" name=\"skuSort\" readonly='readonly' value='THREE'  placeholder=\"排序\" />\n" +
        "\t\t\t\t\t\t\t</div>\n" +
        "\t\t\t\t\t\t</div>\n" +
        "\t\t\t\t\t\t<div class=\"col-md-2\">\n" +
        "\t\t\t\t\t\t\t<div class=\"form-group\">\n" +
        "\t\t\t\t\t\t\t\t<label for=\"field-6\" class=\"control-label\">操作</label>\n" +
        "\t\t\t\t\t\t\t\t<input type=\"button\" class=\"form-control UUID\" name=\"UUID\" value='删除' DELETE onclick=\"delNode(this,false)\" />\n" +
        "\t\t\t\t\t\t\t</div>\n" +
        "\t\t\t\t\t\t</div>\n" +
        "\t\t\t\t\t</div>\n";

    var ATTR_ELEMENT_FOOTER = "\t\t\t\t\t<input type=\"button\" value=\"添加详细规格(如红、黄、S、M、L)\" onclick=\"addMoreAttrValue(this)\" />\n" +
        "\t\t\t\t</div>\n" +
        "\t\t\t\t<div class=\"modal-footer\">\n" +
        "\t\t\t\t\t<button type=\"button\" class=\"btn btn-danger\" data-dismiss=\"modal\">关闭</button>\n" +
        "\t\t\t\t\t<button type=\"button\" class=\"btn btn-success\" onclick=\"saveAttr('PID')\">保存</button>\n" +
        "\t\t\t\t</div>\n" +
        "\t\t\t</div>\n" +
        "\t\t</div>";

    var ATTR_ELEMENT_FOOTER_IMG = "\t\t\t\t\t<input type=\"button\" value=\"添加详细规格(如红、黄、S、M、L)\" onclick=\"addMoreAttrValue(this,true)\" />\n" +
        "\t\t\t\t</div>\n" +
        "\t\t\t\t<div class=\"modal-footer\">\n" +
        "\t\t\t\t\t<button type=\"button\" class=\"btn btn-danger\" data-dismiss=\"modal\">关闭</button>\n" +
        "\t\t\t\t\t<button type=\"button\" class=\"btn btn-success\" onclick=\"saveAttr('PID',true)\">保存</button>\n" +
        "\t\t\t\t</div>\n" +
        "\t\t\t</div>\n" +
        "\t\t</div>";

    function showAttrWindow(uuid, hasImg) {
        var target = $("." + uuid);
        var attrJSONStr = target.find("input[name=attrContainer]").val();
        var contentStr = "";
        if (attrJSONStr == '') {
            var innerUUid = UUID.randomUUID();
            if (hasImg) {
                contentStr = (ATTR_ELEMENT_HEADER + ATTR_ELEMENT_BODY_IMG + ATTR_ELEMENT_FOOTER_IMG).replace("ONE", "").replace("TWO", "").replace("THREE", "0").replace("FOUR", "").replace("DELETE", "").replace(/PID/g, uuid).replace(/UUID/g, innerUUid);
            } else {
                contentStr = (ATTR_ELEMENT_HEADER + ATTR_ELEMENT_BODY + ATTR_ELEMENT_FOOTER).replace("ONE", "").replace("TWO", "").replace("THREE", "0").replace("DELETE", "").replace(/PID/g, uuid).replace(/UUID/g, innerUUid);
            }
        } else {
            var attrList = JSON.parse(attrJSONStr);
            contentStr += ATTR_ELEMENT_HEADER;
            for (var i in attrList) {
                var innerUUid = UUID.randomUUID();
                if (hasImg) {
                    contentStr += buildNewAttrValue(innerUUid, attrList[i]["value"], attrList[i]["remark"], attrList[i]["sort"], attrList[i]["img"], true, true);
                } else {
                    contentStr += buildNewAttrValue(innerUUid, attrList[i]["value"], attrList[i]["remark"], attrList[i]["sort"], "", true, false);
                }
            }
            if (hasImg) {
                contentStr += ATTR_ELEMENT_FOOTER_IMG.replace(/PID/g, uuid);
            } else {
                contentStr += ATTR_ELEMENT_FOOTER.replace(/PID/g, uuid);
            }
        }
        jQuery('#modal-7').html(contentStr).modal({backdrop: 'static', keyboard: false});
    }

    function saveAttr(uuid, hasImg) {
        var form = jQuery('#modal-7');
        var skuValueList = form.find("input[name=skuValue]");
        var skuRemarkList = form.find("input[name=skuRemark]");
        var skuImgList = form.find("input[name=skuImg]");
        var skuSortList = form.find("input[name=skuSort]");
        var list = [];
        var valueList = [];
        for (var i in skuValueList) {
            if (isNaN(i)) {
                continue;
            }
            var value = skuValueList[i].value;
            var remark = skuRemarkList[i].value;
            var sort = skuSortList[i].value;
            var item = {"value": value, "remark": remark, "sort": sort};
            if (hasImg) {
                item["img"] = skuImgList[i].value;
            }
            list.push(item);
            valueList.push(value);
        }
        var target = $("." + uuid);
        target.find("input[name=attrContainer]").val(JSON.stringify(list));
        target.find("input[name=attrValue]").val(valueList.join(","));
        //build SKU
        generateSKUList();
        form.modal('toggle');
    }

    function generateSKUList(stockList) {
        SkuStockList = [];
        SkuStockDetailList = [];
        SkuStockSavedList = [];
        var stockHolder = $("#stockHolder");
        if (stockList != null) {
            stockHolder.val(JSON.stringify(stockList));
            SkuStockSavedList = stockList;
        } else {
            SkuStockSavedList = JSON.parse(stockHolder.val());
        }
        console.log(SkuStockSavedList);
        var target = $("#skuContainer");
        var form = $("#saveForm");
        var attrNameArr = form.find("input[name=attrName]");
        var attrValueArr = form.find("input[name=attrValue]");
        var attrContainerArr = form.find("input[name=attrContainer]");
        var attrArr = [];
        var nameArr = [];
        var containerArr = [];
        for (var i in attrValueArr) {
            if (isNaN(i)) {
                continue;
            }
            var attr = attrValueArr[i].value;
            var name = attrNameArr[i].value;
            var containerStr = attrContainerArr[i].value;
            attrArr.push(attr.split(","));
            nameArr.push(name);
            containerArr.push(JSON.parse(containerStr));
        }
        mergeSKURecursively(attrArr, nameArr, containerArr, 0, "", []);
        var contentStr = "";
        for (var i in SkuStockList) {
            var iDStr = "";
            for (var j in SkuStockDetailList[i]) {
                var item = SkuStockDetailList[i][j];
                iDStr += item["name"];
                iDStr += item["value"]["value"];
            }
            if (SkuStockSavedList.hasOwnProperty(iDStr)) {
                console.log("IN");
                console.log(iDStr);
                var obj = SkuStockSavedList[iDStr];
                console.log(obj);
                var imgUrl = SkuStockDetailList[i][0]["value"].hasOwnProperty("img") && SkuStockDetailList[i][0]["value"]["img"] != "" ? SkuStockDetailList[i][0]["value"]["img"] : obj["image"];
                contentStr += buildSKUItem(SkuStockList[i], SkuStockDetailList[i], obj["id"], obj["sku"], imgUrl, obj["stock"], obj["price"]);
            } else {
                console.log("OUT");
                console.log(iDStr);
                var imgUrl = SkuStockDetailList[i][0]["value"]["img"];
                contentStr += buildSKUItem(SkuStockList[i], SkuStockDetailList[i], null, null, imgUrl);
            }
        }
        if (contentStr != '') {
            contentStr = buildButton("<input type=\"button\" name='batch' value=\"批量设置库存数量\" onclick=\"batchSetStockNum()\">") + contentStr;
        }
        target.html(contentStr);
    }

    function batchSetStockNum() {
        var num = prompt("输入库存数量", "0");
        if (!isNaN(num)) {
            $("#skuContainer").find("[name='skuStock']").val(num);
        } else {
            alert("请输入数字!");
        }
    }

    var SkuStockList = [];
    var SkuStockDetailList = [];
    var SkuStockSavedList = [];

    function mergeSKURecursively(arr, nameArr, containerArr, i, previousItem, skuDetailArr) {
        for (var obj in arr[i]) {
            var newPreviousItem = previousItem + arr[i][obj] + "_";
            var newSkuDetailArr = JSON.parse(JSON.stringify(skuDetailArr));//deep copy
            newSkuDetailArr.push(
                {
                    "name": nameArr[i],
                    "value": containerArr[i][obj]
                }
            );
            if (arr.hasOwnProperty(i + 1)) {
                mergeSKURecursively(arr, nameArr, containerArr, i + 1, newPreviousItem, newSkuDetailArr);
            } else {
                SkuStockList.push(newPreviousItem);
                SkuStockDetailList.push(newSkuDetailArr);
            }
        }
    }

    function buildButton(button1) {
        return "                        <div class=\"row\">\n" +
            "                            <div class=\"col-md-2\">\n" +
            "                                <div class=\"form-group\">\n" +
            "                                </div>\n" +
            "                            </div>\n" +
            "                            <div class=\"col-md-2\">\n" +
            "                                <div class=\"form-group\">\n" +
            "                                </div>\n" +
            "                            </div>\n" +
            "                            <div class=\"col-md-2\">\n" +
            "                                <div class=\"form-group\">\n" +
            button1 +
            "                                </div>\n" +
            "                            </div>\n" +
            "                            <div class=\"col-md-4\">\n" +
            "                                <div class=\"form-group\">\n" +
            "                                </div>\n" +
            "                            </div>\n" +
            "                        </div>";
    }

    function buildSKUItem(remark, skuDetail, id, sku, skuImage, skuStock, skuPrice) {
        return "                        <div class=\"row\">\n" +
            "                            <div class=\"col-md-2\">\n" +
            "                                <div class=\"form-group\">\n" +
            "                                    <label class=\"control-label\">SKU编码</label>\n" +
            "                                    <input type=\"text\" class=\"form-control\" name=\"sku\" placeholder=\"SKU编码\" value='VALUE' />\n".replace("VALUE", sku != null ? sku : "") +
            "                                    <input type=\"hidden\" name=\"skuId\" value='VALUE' />\n".replace("VALUE", id != null ? id : "") +
            "                                </div>\n" +
            "                            </div>\n" +
            "                            <div class=\"col-md-2\">\n" +
            "                                <div class=\"form-group\">\n" +
            "                                    <label class=\"control-label\">库存图片</label>\n" +
            "                                    <input type=\"file\" class=\"form-control\" name=\"skuImageFile\" placeholder=\"库存图片\" />\n" +
            "                                    <input type=\"hidden\" class=\"form-control\" name=\"skuImage\" value='VALUE' />\n".replace("VALUE", skuImage != null ? skuImage : "") +
            "                                    <img src=\"SRC\" name=\"skuImageImg\" style=\"STYLE;\" />\n".replace("SRC", skuImage != null ? skuImage : "").replace("STYLE", skuImage != null ? "display:block;width:200px;height:200px" : "display:none") +
            "                                </div>\n" +
            "                            </div>\n" +
            "                            <div class=\"col-md-2\">\n" +
            "                                <div class=\"form-group\">\n" +
            "                                    <label class=\"control-label\">库存余量</label>\n" +
            "                                    <input type=\"number\" class=\"form-control\" name=\"skuStock\" placeholder=\"库存余量\" value='VALUE' />\n".replace("VALUE", skuStock != null ? skuStock : "") +
            "                                </div>\n" +
            "                            </div>\n" +
            "                            <div class=\"col-md-4\">\n" +
            "                                <div class=\"form-group\">\n" +
            "                                    <label class=\"control-label\">备注</label>\n" +
            "                                    <input type=\"text\" class=\"form-control\" name=\"skuRemark\" value=\"REMARK\" placeholder=\"备注\" />\n".replace("REMARK", remark) +
            "                                    <input type=\"hidden\" class=\"form-control\" name=\"skuDetail\" value=\"DETAIL\" />\n".replace("DETAIL", $.base64.btoa(JSON.stringify(skuDetail))) +
            "                                </div>\n" +
            "                            </div>\n" +
            "                        </div>";
    }

    function formatTime(time) {
        return new Date(time).Format("yyyy-MM-dd hh:mm:ss");
    }

    function buildImg(url) {
        return "<img width='100px' height='100px' src='#' />".replace("#", url);
    }

    function bindTypeSelector(data, v1, v2, v3) {
        var typeStr = "";
        var i = 0;
        for (var j in data) {
            var type = data[j];
            if (type["name"] == v1) {
                i = j;
                typeStr += '<option value="VALUE" selected="selected">KEY</option>'.replace("VALUE", type["id"]).replace("KEY", type["name"]);
            } else {
                typeStr += '<option value="VALUE">KEY</option>'.replace("VALUE", type["id"]).replace("KEY", type["name"]);
            }
        }
        $("#type").html(typeStr);
        bindCategorySelector(data[i]["sub"], v2, v3);
    }

    function bindCategorySelector(data, v, vv) {
        var categoryStr = "";
        var i = 0;
        for (var k in data) {
            var category = data[k];
            if (category["name"] == v) {
                i = k;
                categoryStr += '<option value="VALUE" selected="selected">KEY</option>'.replace("VALUE", category["id"]).replace("KEY", category["name"]);
            } else {
                categoryStr += '<option value="VALUE">KEY</option>'.replace("VALUE", category["id"]).replace("KEY", category["name"]);
            }
        }
        $("#category").html(categoryStr);
        if (data[i]["sub"]) {
            bindKindSelector(data[i]["sub"], vv);
        }
    }

    function bindKindSelector(data, v) {
        var kindStr = "";
        for (var kind in data) {
            kind = data[kind];
            if (kind["name"] == v) {
                kindStr += '<option value="VALUE" selected="selected">KEY</option>'.replace("VALUE", kind["id"]).replace("KEY", kind["name"]);
            } else {
                kindStr += '<option value="VALUE">KEY</option>'.replace("VALUE", kind["id"]).replace("KEY", kind["name"]);
            }
        }
        $("#kind").html(kindStr);
    }

    function renderCategory(self) {
        var jsonStr = $("#type_and_category_list").val();
        var list = JSON.parse(jsonStr);
        var selectedId = $(self).val();
        for (var type in list) {
            if (selectedId == list[type]["id"]) {
                bindCategorySelector(list[type]["sub"]);
                break;
            }
        }
    }

    function renderKind(self) {
        var jsonStr = $("#type_and_category_list").val();
        var list = JSON.parse(jsonStr);
        var selectedId = $(self).val();
        loop:for (var type of list) {
            for (var category of type["sub"]) {
                if (selectedId == category["id"]) {
                    bindKindSelector(category["sub"]);
                    break loop;
                }
            }
        }
    }

    function bindBrandSelector(data, id) {
        var brandStr = "";
        for (var brand in data) {
            brand = data[brand];
            if (brand.hasOwnProperty("brandId") && brand.hasOwnProperty("brandName")) {
                if (brand["brandId"] == id) {
                    brandStr += '<option value="VALUE" selected="selected">KEY</option>'.replace("VALUE", brand["brandId"]).replace("KEY", brand["brandName"]);
                } else {
                    brandStr += '<option value="VALUE">KEY</option>'.replace("VALUE", brand["brandId"]).replace("KEY", brand["brandName"]);
                }
            } else {
                if (brand["id"] == id) {
                    brandStr += '<option value="VALUE" selected="selected">KEY</option>'.replace("VALUE", brand["id"]).replace("KEY", brand["name"]);
                } else {
                    brandStr += '<option value="VALUE">KEY</option>'.replace("VALUE", brand["id"]).replace("KEY", brand["name"]);
                }
            }
        }
        $("#field-5").html(brandStr);
    }

    function checkImg(list) {
        var returnList = {};
        for (var i in list) {
            i = list[i];
            var v = i[0];
            var name = i[1];
            var form = $("#saveForm");
            var footer = $(this).parent(".modal-footer");
            var imageFile = '';
            //上传文件获得文件地址
            if (v != '') {
                imageFile = form.find("input[name='" + name + "File']")[0].files[0];
                returnList[name] = imageFile;
            }
        }
        return returnList;
    }

    var qiniuUrl = [[${qiniuUrl}]];
    var theId = [[${theId}]];
    jQuery(document).ready(function ($) {
        $.base64.utf8encode = true;
        $.base64.utf8decode = true;

        if (theId != null) {
            $.getJSON("/goods_find", {"id": theId}, function (data) {
                console.log(data);
                var form = $("#saveForm");
                var main = data["main"];
                var imageList = data["imageList"];
                var propertyList = data["propertyList"];
                var stockList = data["stockList"];
                var stockMap = data["stockMap"];
                //main
                for (var i in main) {
                    var ele = form.find("input[name='" + i + "']");
                    switch (ele.attr("type")) {
                        case "radio":
                            ele.val([main[i]]);
                            break;
                        default:
                            if (main[i] != undefined && !isNaN(main[i]) && String(main[i]).length == 13) {
                                ele.val(formatTime(main[i]));
                                $("#" + i).val(formatTime(main[i]));
                            } else {
                                ele.val(main[i]);
                            }
                    }
                    form.find("img[name='" + i + "Img']").attr("src", main[i]);
                    form.find("img[name='" + i + "Img']").attr("width", 200);
                    form.find("img[name='" + i + "Img']").attr("length", 200);
                    form.find("img[name='" + i + "Img']").show();
                }
                //分类
                $.getJSON("/type_and_category_list", {}, function (data) {
                    $("#type_and_category_list").val(JSON.stringify(data));
                    bindTypeSelector(data, main["type"], main["category"], main["kind"]);
                });
                //品牌
                $.getJSON("/brand_list_all", {}, function (data) {
                    bindBrandSelector(data, main["brandId"]);
                    $('#field-5').editableSelect();
                });
                //图片
                var bannerHide = form.find("[name='banner']");
                var bannerImg = form.find("[name='bannerImg']");
                var bannerReset = form.find("[name='bannerReset']");
                var bannerIndex = 0;
                for (var image in imageList) {
                    image = imageList[image];
                    //类型[0-banner,1-内容]
                    if (image["type"] == '0') {
                        $(bannerHide[bannerIndex]).val(image["imageUrl"]);
                        $(bannerImg[bannerIndex]).attr("src", image["imageUrl"]);
                        $(bannerImg[bannerIndex]).css({'height': '200px', 'width': '200px'});
                        $(bannerImg[bannerIndex]).show();
                        $(bannerReset[bannerIndex]).show();
                        bannerIndex++;
                    } else {
                        addIntroFile("#addIntroFileBtn", image["imageUrl"]);
                    }
                }
                //可拖动
                $("#bannerDIV").sortable();
                $("#bannerDIV").disableSelection();
                $("#introDIV").sortable();
                $("#introDIV").disableSelection();
                //规格
                var savedSku = {
                    // "颜色": [
                    //     // {"value": "赤", "remark": "", "sort": 1},
                    //     // {"value": "橙", "remark": "", "sort": 2},
                    //     // {"value": "黄", "remark": "", "sort": 3},
                    //     // {"value": "绿", "remark": "", "sort": 4},
                    //     // {"value": "青", "remark": "", "sort": 5},
                    //     // {"value": "蓝", "remark": "", "sort": 6},
                    //     // {"value": "紫", "remark": "", "sort": 7}
                    // ],
                    // "尺码": [
                    //     // {"value": "大", "remark": "L", "sort": 1},
                    //     // {"value": "小", "remark": "S", "sort": 2},
                    //     // {"value": "中", "remark": "M", "sort": 3},
                    //     // {"value": "特大", "remark": "XL", "sort": 4},
                    //     // {"value": "特小", "remark": "XS", "sort": 5},
                    //     // {"value": "特特大", "remark": "XXL", "sort": 6},
                    //     // {"value": "特特小", "remark": "XXS", "sort": 7}
                    // ]
                };
                loop:for (var property in propertyList) {
                    // {
                    //     "id": 509,
                    //     "goodsId": 60,
                    //     "goodsStockId": 270,
                    //     "name": "颜色",
                    //     "value": "黑色",
                    //     "sort": 0,
                    //     "createTime": 1555583063000,
                    //     "remark": ""
                    // }
                    property = propertyList[property];
                    if (savedSku.hasOwnProperty(property["name"])) {
                        var tmpArr = savedSku[property["name"]];
                        for (var tmpObj in tmpArr) {
                            tmpObj = tmpArr[tmpObj];
                            if (tmpObj["value"] == property["value"]) {
                                continue loop;
                            }
                        }
                        tmpArr.push(
                            {
                                "value": property["value"],
                                "remark": property["remark"],
                                "sort": property["sort"]
                            }
                        );
                    } else {
                        savedSku[property["name"]] = [
                            {
                                "value": property["value"],
                                "remark": property["remark"],
                                "sort": property["sort"]
                            }
                        ];
                    }
                }
                console.log(savedSku);
                switchToCommon(savedSku);
                //库存
                generateSKUList(stockMap);
            });
        }

        $(document).on("wheel", "input[type=number]", function (e) {
            $(this).blur();
        });

        // switchToCommon();

        //保存
        $(".btn.btn-info.save").click(function () {
            var footer = $(this).parent(".modal-footer");
            var form = $("#saveForm");
            var type = form.find("select[name='type']").val();
            var category = form.find("select[name='category']").val();
            var kind = form.find("select[name='kind']").val();
            var isOffway = form.find("input[name='isOffway']:checked").val();
            var id = form.find("input[name='id']").val();
            var name = form.find("input[name='name']").val();
            // var brand_id = form.find("select[name='brand_id']").val();
            var brand_id = form.find("input[name='brand_id']").parent().find("li.es-visible").val();
            var remark = form.find("input[name='remark']").val();
            //文件
            var image = form.find("input[name='imageFile']").val();
            //已上传的图片地址
            var imageImg = form.find("input[name='image']").val();

            if (type == '' || category == '' || name == '' || brand_id == '' || (image == '' && imageImg == '')) {
                toastr.error("请填写完整数据后提交", "温馨提示");
                return;
            }
            var isOK = checkImg([[image, "image"]]);
            if (typeof isOK == 'boolean') {
                return;
            }

            //多个元素 sku 属性
            var attrName = form.find("input[name='attrName']");
            // var attrValue = form.find("input[name='attrValue']").val();//omit
            var attrContainer = form.find("input[name='attrContainer']");
            var attrNameList = [];
            var attrContainerList = [];
            for (var i in attrName) {
                if (isNaN(i)) {
                    continue;
                }
                var a = attrName[i].value;
                var b = attrContainer[i].value;
                if (a == '' || b == '') {
                    toastr.error("请填写完整数据后提交", "温馨提示");
                    return;
                } else {
                    attrNameList.push(a);
                    attrContainerList.push(b);
                }
            }
            //多个元素 sku stock
            var sku = form.find("input[name='sku']");
            var skuStock = form.find("input[name='skuStock']");
            var skuRemark = form.find("input[name='skuRemark']");
            var skuImage = form.find("input[name='skuImageFile']");
            var skuImageSaved = form.find("input[name='skuImage']");
            var skuDetail = form.find("input[name='skuDetail']");
            var skuId = form.find("input[name='skuId']");
            var stockList = [];
            for (var j in sku) {
                if (isNaN(j)) {
                    continue;
                }
                var c = sku[j].value;
                var d = skuStock[j].value;
                var f = skuRemark[j].value;
                var g = skuImage[j].value;
                var h = skuDetail[j].value;
                var m = skuId[j].value;
                var n = skuImageSaved[j].value;
                if (c == '' || d == '' || f == '' || (g == '' && n == '')) {
                    toastr.error("请填写完整数据后提交", "温馨提示");
                    return;
                } else {
                    stockList.push({
                        "id": m,
                        "sku": c,
                        "stock": d,
                        "remark": f,
                        "image": g == '' ? n : skuImage[j].files[0],
                        "detail": h
                    });
                }
            }
            //banner 轮播图
            var banner = form.find("input[name='banner']");
            var bannerList = [];
            for (var k in banner) {
                if (isNaN(k)) {
                    continue;
                }
                var bUrl = banner[k].value;
                if (bUrl == '') {
                    //skip
                } else {
                    bannerList.push(bUrl);
                }
            }
            //商品长图
            var intro = form.find("input[name='intro']");
            var introList = [];
            for (var l in intro) {
                if (isNaN(l)) {
                    continue;
                }
                var iUrl = intro[l].value;
                if (iUrl == '') {
                    //skip
                } else {
                    introList.push(iUrl);
                }
            }
            //获取token
            $.get("/qiniu/token", {}, function (token) {
                if (token != '') {
                    async.series({
                        one: function (callback) {
                            async.eachSeries(stockList, function (item, cb) {
                                var f = item["image"];
                                if (f instanceof File) {
                                    this.upload("", token, f, function () {
                                        //
                                    }, function (err) {
                                        console.log("上传imageFile异常:" + err);
                                        cb(err);
                                    }, function (res) {
                                        //上传成功
                                        if (res != '') {
                                            var url = qiniuUrl + "/" + res.key;
                                            item["image"] = url;
                                        }
                                        cb();
                                    });
                                } else {
                                    item["image"] = f;
                                    cb();
                                }
                            }, function () {
                                callback();
                            });
                        },
                        two: function (callback) {
                            //上传详情图
                            async.eachSeries(Object.keys(isOK), function (item, cb) {
                                var f = isOK[item];
                                this.upload(item, token, f, function () {
                                    //
                                }, function (err) {
                                    console.log("上传imageFile异常:" + err);
                                    cb(err);
                                }, function (res) {
                                    //上传成功
                                    if (res != '') {
                                        var url = qiniuUrl + "/" + res.key;
                                        form.find("input[name='" + res.param + "']").val(url);
                                    }
                                    cb();
                                });
                            }, function () {
                                callback();
                            });
                        },
                        three: function (callback) {
                            //提交保存
                            var data = {
                                "id": id,
                                "name": name,
                                "image": form.find("input[name='image']").val(),
                                "brandId": brand_id,
                                "type": type,
                                "category": category,
                                "kind": kind,
                                "isOffway": isOffway,
                                "remark": remark,
                                "stocks": JSON.stringify(stockList),
                                "banners": bannerList.join(","),
                                "intros": introList.join(",")
                            };
                            console.log(data);
                            $.post("/goods_add", data, function (data) {
                                if (data) {
                                    footer.find("button").show();
                                    footer.find(".bg-lg").hide();
                                    jQuery('#modal-6').modal('hide');
                                    toastr.success("操作已成功！", "温馨提示");
                                    callback();
                                } else {
                                    footer.find("button").show();
                                    footer.find(".bg-lg").hide();
                                    toastr.error("操作失败", "温馨提示");
                                    callback("ERROR");
                                }
                            });
                            $(".btn.btn-info.save").attr("disabled", "disabled");
                        }
                    }, function (err, results) {
                        if (err) {
                            $(".btn.btn-info.save").attr("disabled", "");
                        } else {
                            setTimeout(function () {
                                window.close();
                            }, 2000);
                        }
                    });
                } else {
                    footer.find("button").show();
                    footer.find(".bg-lg").hide();
                    toastr.error("上传文件错误，请联系管理员", "温馨提示");
                }
            });
        });
    });
    /*]]>*/
</script>
</body>

</html>
